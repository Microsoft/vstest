<!--
***********************************************************************************************
Microsoft.TestPlatform.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved. 
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Load Microsoft.TestPlatform.Build.Tasks.dll, this can be overridden to use a different version with $(VSTestTaskAssemblyFile) -->
  <PropertyGroup>
    <VSTestTaskAssemblyFile Condition="$(VSTestTaskAssemblyFile) == ''">Microsoft.TestPlatform.Build.dll</VSTestTaskAssemblyFile>
    <VSTestConsolePath Condition="$(VSTestConsolePath) == ''">$([System.IO.Path]::Combine($(MSBuildThisFileDirectory),"vstest.console.dll"))</VSTestConsolePath>
  </PropertyGroup>
  <UsingTask TaskName="Microsoft.TestPlatform.Build.Tasks.VSTestTask" AssemblyFile="$(VSTestTaskAssemblyFile)" />
  <UsingTask TaskName="Microsoft.TestPlatform.Build.Tasks.VSTestLogsTask" AssemblyFile="$(VSTestTaskAssemblyFile)" />

  <!--
    ============================================================
    Test target
    Main entry point for running tests through vstest.console.exe
    ============================================================
  -->
  <Target Name="VSTest" DependsOnTargets="ShowInfoMessageIfProjectHasNoIsTestProjectProperty">
    <CallTarget Condition="!$(VSTestNoBuild) AND $(IsTestProject)" Targets="BuildProject" />
    
    <CallTarget Targets="ShowCallOfVSTestTaskWithParameter" />

    <Microsoft.TestPlatform.Build.Tasks.VSTestTask
      TestFileFullPath="$(TargetPath)"
      VSTestSetting="$([MSBuild]::ValueOrDefault($(VSTestSetting), '$(RunSettingsFilePath)'))"
      VSTestTestAdapterPath="$(VSTestTestAdapterPath)"
      VSTestFramework="$(TargetFrameworkMoniker)"
      VSTestPlatform="$(PlatformTarget)"
      VSTestTestCaseFilter="$(VSTestTestCaseFilter)"
      VSTestLogger="$(VSTestLogger)"
      VSTestListTests="$(VSTestListTests)"
      VSTestDiag="$(VSTestDiag)"
      VSTestCLIRunSettings="$(VSTestCLIRunSettings)"
      VSTestConsolePath="$(VSTestConsolePath)"
      VSTestResultsDirectory="$(VSTestResultsDirectory)"
      VSTestVerbosity="$(VSTestVerbosity)"
      VSTestCollect="$(VSTestCollect)"
      VSTestBlame="$(VSTestBlame)"
      VSTestBlameCrash="$(VSTestBlameCrash)"
      VSTestBlameCrashDumpType="$(VSTestBlameCrashDumpType)"
      VSTestBlameCrashCollectAlways="$(VSTestBlameCrashCollectAlways)"
      VSTestBlameHang="$(VSTestBlameHang)"
      VSTestBlameHangDumpType="$(VSTestBlameHangDumpType)"
      VSTestBlameHangTimeout="$(VSTestBlameHangTimeout)"
      VSTestTraceDataCollectorDirectoryPath="$(TraceDataCollectorDirectoryPath)"
      VSTestNoLogo="$(VSTestNoLogo)"
      YieldDuringToolExecution="True"
      Condition="$(IsTestProject)"
    />
  </Target>

  <Target Name="ShowInfoMessageIfProjectHasNoIsTestProjectProperty" Condition="'$(IsTestProject)' == ''">
    <Microsoft.TestPlatform.Build.Tasks.VSTestLogsTask LogType="NoIsTestProjectProperty" ProjectFilePath="$(MSBuildProjectFullPath)" />
  </Target>

  <Target Name="BuildProject">
    <CallTarget Targets="ShowMsbuildWithParameter" />

    <Microsoft.TestPlatform.Build.Tasks.VSTestLogsTask LogType="BuildStarted" />
    <MSBuild Projects ="$(MSBuildProjectFullPath)" />
    <Microsoft.TestPlatform.Build.Tasks.VSTestLogsTask LogType="BuildCompleted" />

    <Message Text="Done Building project $(MSBuildProjectFullPath) for TargetFramework=$(TargetFramework)" Importance="Low" />
  </Target>
  
  <Target Name="ShowMsbuildWithParameter">
    <Message Text="Building project $(MSBuildProjectFullPath) for TargetFramework=$(TargetFramework)" Importance="Low"/>
    <Message Text="Value passed to msbuild are..." Importance="Low" />
    <Message Text="Configuration = $(Configuration)" Importance="Low" />
    <Message Text="TargetFramework = $(TargetFramework)" Importance="Low" />
    <Message Text="Platform = $(PlatformTarget)" Importance="Low" />
    <Message Text="OutputPath = $(OutputPath)" Importance="Low" />
  </Target>
  
  <Target Name="ShowCallOfVSTestTaskWithParameter">
    <Message Text="Calling task Microsoft.TestPlatform.Build.Tasks.VSTestTask with following parameter..." Importance="Low" />
    <Message Text="TestFileFullPath = $(TargetPath)" Importance="Low" />
    <Message Text="VSTestSetting = $(VSTestSetting)" Importance="Low" />
    <Message Text="VSTestTestAdapterPath = $(VSTestTestAdapterPath)" Importance="Low" />
    <Message Text="VSTestFramework = $(TargetFrameworkMoniker)" Importance="Low" />
    <Message Text="VSTestPlatform = $(PlatformTarget)" Importance="Low" />
    <Message Text="VSTestTestCaseFilter = $(VSTestTestCaseFilter)" Importance="Low" />
    <Message Text="VSTestLogger = $(VSTestLogger)" Importance="Low" />
    <Message Text="VSTestListTests = $(VSTestListTests)" Importance="Low" />
    <Message Text="VSTestDiag = $(VSTestDiag)" Importance="Low" />
    <Message Text="VSTestCLIRunSettings = $(VSTestCLIRunSettings)" Importance="Low" />
    <Message Text="VSTestResultsDirectory = $(VSTestResultsDirectory)" Importance="Low" />
    <Message Text="VSTestConsolePath = $(VSTestConsolePath)" Importance="Low" />
    <Message Text="VSTestVerbosity = $(VSTestVerbosity)" Importance="Low" />
    <Message Text="VSTestCollect = $(VSTestCollect)" Importance="Low" />
    <Message Text="VSTestBlame = $(VSTestBlame)" Importance="Low" />
    <Message Text="VSTestTraceDataCollectorDirectoryPath = $(TraceDataCollectorDirectoryPath)" Importance="Low" />
    <Message Text="VSTestNoLogo = $(VSTestNoLogo)" Importance="Low" />
  </Target>

</Project>
