From bcb00c2086247b4ff1bccd0db2d7f3122bddf669 Mon Sep 17 00:00:00 2001
From: Medeni Baykal <433724+Haplois@users.noreply.github.com>
Date: Thu, 17 Jun 2021 01:08:15 +0200
Subject: [PATCH] Build for NET 6

---
 scripts/build.sh                                               | 2 +-
 .../Hosting/DotnetTestHostManager.cs                           | 2 +-
 src/package/nuspec/TestPlatform.CLI.nuspec                     | 2 +-
 src/vstest.console/vstest.console.csproj                       | 3 ++-
 4 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/scripts/build.sh b/scripts/build.sh
index aa44e9f4..48ca1cae 100755
--- a/scripts/build.sh
+++ b/scripts/build.sh
@@ -142,7 +142,7 @@ DOTNET_CLI_VERSION=$_ReadGlobalVersion
 TPB_Solution="TestPlatform.sln"
 TPB_Build_From_Source_Solution="TestPlatform_BuildFromSource.sln"
 TPB_TargetFramework="net451"
-TPB_TargetFrameworkCore="netcoreapp2.1"
+TPB_TargetFrameworkCore="net6.0"
 TPB_Configuration=$CONFIGURATION
 TPB_TargetRuntime=$TARGET_RUNTIME
 TPB_Version=$(test -z $VERSION_SUFFIX && echo $VERSION || echo $VERSION-$VERSION_SUFFIX)
diff --git a/src/Microsoft.TestPlatform.TestHostProvider/Hosting/DotnetTestHostManager.cs b/src/Microsoft.TestPlatform.TestHostProvider/Hosting/DotnetTestHostManager.cs
index 55c8d8d2..22a13dd5 100644
--- a/src/Microsoft.TestPlatform.TestHostProvider/Hosting/DotnetTestHostManager.cs
+++ b/src/Microsoft.TestPlatform.TestHostProvider/Hosting/DotnetTestHostManager.cs
@@ -252,7 +252,7 @@ namespace Microsoft.VisualStudio.TestPlatform.CrossPlatEngine.Hosting
                         // testhost.(x86).exe is present in location {testHostNugetRoot}\build\netcoreapp2.1\{x86/x64}\{testhost.x86.exe/testhost.exe}
                         var folderName = this.architecture == Architecture.X86 ? "x86" : "x64";
                         var testHostNugetRoot = new DirectoryInfo(testHostPath).Parent.Parent.Parent;
-                        var testHostExeNugetPath = Path.Combine(testHostNugetRoot.FullName, "build", "netcoreapp2.1", folderName, exeName);
+                        var testHostExeNugetPath = Path.Combine(testHostNugetRoot.FullName, "build", "net6.0", folderName, exeName);
 
                         if (this.fileHelper.Exists(testHostExeNugetPath))
                         {
diff --git a/src/package/nuspec/TestPlatform.CLI.nuspec b/src/package/nuspec/TestPlatform.CLI.nuspec
index 0e72bf58..01b624c0 100644
--- a/src/package/nuspec/TestPlatform.CLI.nuspec
+++ b/src/package/nuspec/TestPlatform.CLI.nuspec
@@ -29,6 +29,6 @@
     <!-- Add a third party notice file -->
     <file src="ThirdPartyNotices.txt" target="" />
     
-    <file src="netcoreapp2.1\**\*.*" exclude="**\*.pdb" target="contentFiles\any\netcoreapp2.1" />
+    <file src="net6.0\**\*.*" exclude="**\*.pdb" target="contentFiles\any\net6.0" />
   </files>
 </package>
diff --git a/src/vstest.console/vstest.console.csproj b/src/vstest.console/vstest.console.csproj
index 6f4b8fdd..9767ac5a 100644
--- a/src/vstest.console/vstest.console.csproj
+++ b/src/vstest.console/vstest.console.csproj
@@ -8,6 +8,7 @@
     <AssemblyName>vstest.console</AssemblyName>
     <TargetFrameworks>netcoreapp2.1;net451</TargetFrameworks>
     <TargetFrameworks Condition=" '$(DotNetBuildFromSource)' == 'true' ">netcoreapp2.1;net6.0</TargetFrameworks>
+    <UseAppHost>false</UseAppHost>
     <WarningsAsErrors>true</WarningsAsErrors>
     <OutputType>Exe</OutputType>
     <PlatformTarget Condition="'$(TargetFramework)' == 'net451'">AnyCPU</PlatformTarget>
@@ -15,7 +16,7 @@
     <ApplicationManifest>app.manifest</ApplicationManifest>
     <RootNamespace>Microsoft.VisualStudio.TestPlatform.CommandLine</RootNamespace>
   </PropertyGroup>
-  <PropertyGroup Condition="'$(TargetFramework)' != 'netcoreapp2.1'">
+  <PropertyGroup Condition="'$(TargetFramework)' == 'net451'">
     <RuntimeIdentifier>win7-x64</RuntimeIdentifier>
   </PropertyGroup>
   <ItemGroup>
-- 
2.31.1.windows.1

